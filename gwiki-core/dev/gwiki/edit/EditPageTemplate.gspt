<% form = pageContext.getRequest().getAttribute('form'); 
	 for (me in form.editors) {  me.value.prepareHeader(wikiContext); }
	 wikiContext.requiredJs.add("/static/gwiki/heartbeat.js");
%>
<% wikiContext.skinInclude('standardhead'); %>
<@include file="inc/stdtags.gspt" @> 
<%@ page contentType="text/html;charset=UTF-8" language="java" pageEncoding="UTF-8" %>
<style>
.ui-tabs .ui-tabs-hide {
    position: absolute;
    left: -10000px;
    display: inline !important;
    position:fixed ;
}
</style>
<script>
var gwikiContextPath = '<%= wikiContext.request.contextPath %>';
var gwikiEditPageId ='<c:out value="${form.pageId}"/>';
<%
 StringBuilder localCsse = new StringBuilder();
 for (String lp : wikiContext.getContentCsse()) {
	 if (localCsse.length() > 0) {
		 localCsse.append(",");
	 }
	 localCsse.append(wikiContext.localUrl(lp));
 }
%>
var gwikiContentCss = '<%= localCsse.toString() %>';
var codepressteaids = new Array();
var saveHandlers = new Array();
function onSave()
{
	gwikiContentChanged=false;
	for (var i = 0; i < saveHandlers.length; ++i)
	{
		saveHandlers[i]();
	}
	\$("#formmn").attr("name", "method_onSave");
	\$("#editForm").submit();
}
</script>
<link rel="stylesheet" type="text/css" media="screen" href="<gwiki:url value="/static/skins/naked/ui.jqgrid.css"/>" />
<%--
<script src='<gwiki:url value="/static/jqgrid/js/i18n/grid.locale-de.js" />' type="text/JavaScript"></script>
<script src='<gwiki:url value="/static/jqgrid/js/jquery.jqGrid.min.js" />' type="text/JavaScript"></script>
<script type="text/javascript" src="<gwiki:url value="/static/tiny_mce/tiny_mce_src.js"/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwiki-link-dialog-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwikiedit-wikiops-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwikiedit-toolbar-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwiki-wikitextarea-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwikiedit-frame-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwikiedit-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/gwiki-htmledit-0.3.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/tiny_mce/plugins/gwiki/editor_plugin_src.js'/>"></script> 
<script type="text/javascript" src="<gwiki:url value='/static/gwiki/heartbeat.js'/>"></script>
<script type="text/javascript" src="<gwiki:url value='/static/edit_area/edit_area_full.js'/>"></script>
 --%>
<gwiki:errors />


<c:if test="${form.launchPreview}">
<script>

function openPreviewWindow(url) {
    myWindow = open(url, "preview",
      "dependend=yes,resizable=yes,scrollbars=yes");
    if(myWindow && myWindow.outerWidth && myWindow.outerHeight) {
      /*myWindow.outerWidth = 1200;
      myWindow.outerHeight = 800;*/
    }
    //myWindow.moveTo(40, 40);
    myWindow.focus();
  }  
openPreviewWindow('<gwiki:url value="/${form.pageId}"/>');
</script>
</c:if>
<% %>
<form id="editForm" method="POST" enctype="multipart/form-data">
	<html:hidden property="pageId" /> 
	<input id="formmn" type="hidden" name="m" value=""/>
	<html:hidden property="parentPageId" /><br/>
	

<script>gwikiContentChanged=false;</script>

<% if (form.chooseMetaTemplate == true) { %>
<p>
		<html:select property="metaTemplatePageId" >
			<html:optionsCollection property="availableMetaTemplates" label="key" value="value" />
		</html:select>
</p>
	<input class="gwikiButton main" type="submit" name="method_onInit" value="<fmt:message key="gwiki.edit.EditPage.button.create"/>">
	<input class="gwikiButton reset" type="submit" name="method_onCancel" value="<fmt:message key="gwiki.edit.button.cancel"/>">
<% } else if (form.initalBackup == true) { %>
<script>
function viewBackupDiff()
{
	var url = '<gwiki:url value="/edit/ComparePages"/>?rightPageId=<c:out value="${form.pageId}"/>&leftPageId=<c:out value="${form.backupElementInfo.id}"/>';
	myWindow = open(url, "preview",
  "dependend=yes,resizable=yes,scrollbars=yes");
	if(myWindow && myWindow.outerWidth && myWindow.outerHeight) {
  	/*myWindow.outerWidth = 1200;
  	myWindow.outerHeight = 800;*/
	}
	//myWindow.moveTo(40, 40);
	myWindow.focus();
}
</script>
		Sie haben noch eine alte Sicherung vom <%= wikiContext.getUserDateString(form.backupElementInfo.getModifiedAt()) %>.<br/>
		<a href="javascript:viewBackupDiff()">Vergleichen</a><br/>
		Soll diese weiterbearbeitet werden?<br/>
		<a target="_blank" href="<gwiki:url value="/${form.backupElementInfo.id}"/>?wikiNoCache=true">Seite anschauen</a><br/>
		<br/>
		<input class="gwikiButton main" type="submit" name="method_onInitDeleteBackup" value="Sicherung verwerfen">
		<input class="gwikiButton main" type="submit" name="method_onInitLoadBackup" value="Sicherung laden und weiter bearbeiten">
<% } else { %>

<div id="backupInfo">	
<% if (form.backupElementInfo != null) { %>

<a href="javascript:restoreBackup()">Letzte Sicherung vom <%= wikiContext.getUserDateString(form.backupElementInfo.getModifiedAt()) %> wieder herstellen</a><br/>
<% } %>
</div>
	<fmt:message key="gwiki.edit.EditPage.label.title"/>
	<html:text styleId="editPageTitle" size="80" property="title" /><br/>

<html:hidden property="metaTemplatePageId" />
<html:hidden property="backUrl" />
<html:hidden property="storePath" />
<input id="formCommand" type="hidden" name="formCommand" value="true"/>


<c:if test="${form.elementToEdit.elementInfo.viewable}">
	<input id="gwikieditpreviewbutton" type="submit" class="gwikiButton"  onclick="gwikiContentChanged=false;" name="method_onPreview" value="<fmt:message key="gwiki.edit.EditPage.button.preview"/>">
</c:if>
<input id="gwikieditsavebutton" class="gwikiButton" type="button" name="method_onSave" onclick="onSave();" value="<fmt:message key="gwiki.edit.EditPage.button.save"/>">
<input id="gwikieditcancelbutton" class="gwikiButton" onclick="gwikiContentChanged=false;" class="gwikiButton main" type="submit" name="method_onCancel" value="<fmt:message key="gwiki.edit.button.cancel"/>">
<c:if test="${form.newPage == false}">
<input type="submit" class="gwikiButton" onclick="gwikiContentChanged=false;" name="method_onCopy" value="<fmt:message key="gwiki.edit.button.copy"/>">
<input type="submit" class="gwikiButton" onclick="gwikiContentChanged=false;" name="method_onDelete" value="<fmt:message key="gwiki.edit.button.delete"/>">
</c:if> 
<html:checkbox property="noNotificationEmails"/><fmt:message key="gwiki.edit.EditPage.label.noNotificationEmails"/> 
<html:hidden property="newPage" />
<div id='modalBg'></div><div id='modalContent'></div><div id='loading'></div>
<div id='editDialogBox'></div>
<div id="tabs">
 <ul>
  <%
  	for (me in form.editors) { %>
  	<li><a href="#Editor<%= me.key %>"><span><%= me.value.tabTitle.length() == 0 ? "Default" : me.value.tabTitle %></span></a></li>
 	<%}  %>
    </ul>

 <%
  	for (me in form.editors) { %>
  		<div id="Editor<%= me.key %>" width="100%" height="100%">
  			<% me.value.render(wikiContext); %>
  		</div>
	<% 	}  %>
</div>
<%--
<c:if test="${form.elementToEdit.elementInfo.viewable}">
	<input type="submit" onclick="gwikiContentChanged=false;" name="method_onPreview" value="<fmt:message key="gwiki.edit.EditPage.button.preview"/>">
</c:if>
<input type="submit" name="method_onSave" value="<fmt:message key="gwiki.edit.EditPage.button.save"/>">
<input type="submit" name="method_onCancel" value="<fmt:message key="gwiki.edit.button.cancel"/>">
<a href="javascript:saveAsync()">Async speichern</a>
 --%>

<script type="text/javascript">
function restoreBackup()
{
	var form = jQuery('#editForm');
	jQuery('#formCommand').attr('name', 'method_onInitLoadBackup');
	form.submit();
}

var saveAsync = 	function () {
	if (gwikiContentChanged == false) {
		return;
	}
	var frmqs = jQuery("#editForm").serialize();
  jQuery.ajax({
  	cache: false,
    url: '<gwiki:url value="/edit/EditPage"/>?method_onAsyncSave=true',
    type: 'POST',
    dataType: "html",
    data: frmqs,
    complete: function(res, status) {
      jQuery('#backupInfo').html(res.responseText);
    	}
  });
}  	
	
  \$(document).ready(function(){
    var tabs = \$("#tabs").tabs({ selected: 0 });
    
    \$(".tabindent").indent({spaceForTabs:true, tabWidth:2});

    \$('.wikiPageEditText').autocomplete(
    		'<gwiki:url value="/edit/PageSuggestions"/>', 
    {
			matchContains : true,
			minChars : 0,
			width : 350,
			formatItem : function(row) {
				return row[1] + "<br><i>(" + row[0] + ")</i>";
			}
		});
<% if (form.disableBackup == false) { %>
		\$.jheartbeat.set({
    		delay: 60000,
    		maxBeats:  1000
  		},
  			saveAsync
  	);
<% } %>
 });
  
</script>
<script type="text/javascript" src="<gwiki:url value='/static/tabindent/jquery.tabindent-0.1.js'/>"></script>

<% } %>
</form>

<% wikiContext.skinInclude('standardfoot'); %>